clear;
close all; clc;

% input selected vdl (2 channels on each side of target CH, total 5)
vdl=1;
depth = 1;
vdl = vdl-1;

IMF_compress = zeros(size(vdl));
imfinse = zeros(size(vdl));

for CH = 1:size(vdl, 2)     
    
    Kurtosis = zeros(1, size(vdl, 2));
    % emd for each CH
    [imf, residual] = emd(vdl(:, CH));
    
    % calculate Kurtosis for each IMF of this CH
    for n = 1:size(imf, 2)
        avg_IMF(1, n) = mean(imf(:, n), 1);
        std_IMF(1, n) = std(imf(:, n), 1);
        for m = 1:size(imf, 1)
            diff_IMF(m, n) = (imf(m, n) - avg_IMF(1, n))^4;
        end
        avg_diff(1, n) = mean(diff_IMF(:, n), 1);
        Kurtosis(n) = avg_diff(n)/(std_IMF(n)^4);
    end
    
    % select proper IMF to sum according to Kuritosis
    index1 = 1; 
    index2 = 1; 
    index3 = 1;
    Kurt_temp = Kurtosis(3:end);
    [~, index1] = max(Kurt_temp);
    Kurt_temp(index1) = -Inf;
    [~, index2] = max(Kurt_temp);
    Kurt_temp(index2) = -Inf;
    [~, index3] = max(Kurt_temp);
    Kurt_temp(index3) = -Inf;
    index1 = index1 + 2;
    index2 = index2 + 2;
    index3 = index3 + 2;
    index1 = 3; 
    index2 = 4

    if (Kurtosis(index1) + Kurtosis(index2)) >= 2*sum(Kurtosis(3:end))/2
        IMF_compress(:, CH) = imf(:, index1) + imf(:, index2);
    else
        IMF_compress(:, CH) = imf(:, index1) + imf(:, index2) + imf(:, index3);    
        IMF_compress(:, CH) = imf(:, index1) + imf(:, index2);
    end
    
    if CH>5
        for i = 1:size(IMF_com_avg, 1)
            IMF_com_avg(i, CH) = mean(IMF_compress(i, CH-5:CH));
        end
    else
        IMF_com_avg(:, CH) = IMF_compress(:, CH);
    end
    
    for i=1:size(IMF_com_avg, 1)
        if IMF_com_avg(i) <= 0
            IMF_com_avg(i) = 0;
        end
    end
%     
    [~,~,~,~,imfinse(:, CH)] = hht(IMF_com_avg(:, CH));
    
end
% create new color scale similar to VDL
%newmap = jet;
newmap = [1	0	0
0.996078431	0.007843137	0
0.996078431	0.019607843	0
0.996078431	0.031372549	0
0.996078431	0.043137255	0
0.996078431	0.054901961	0
0.996078431	0.066666667	0
0.996078431	0.078431373	0
0.996078431	0.090196078	0
0.992156863	0.101960784	0
0.992156863	0.11372549	0
0.992156863	0.125490196	0
0.992156863	0.137254902	0
0.992156863	0.149019608	0
0.992156863	0.160784314	0
0.992156863	0.17254902	0
0.992156863	0.184313725	0
0.992156863	0.196078431	0
0.988235294	0.207843137	0
0.988235294	0.219607843	0
0.988235294	0.231372549	0
0.988235294	0.243137255	0
0.988235294	0.254901961	0
0.988235294	0.266666667	0
0.988235294	0.278431373	0
0.988235294	0.290196078	0
0.984313725	0.301960784	0
0.984313725	0.31372549	0
0.984313725	0.325490196	0
0.984313725	0.337254902	0
0.984313725	0.349019608	0
0.984313725	0.360784314	0
0.984313725	0.37254902	0
0.984313725	0.384313725	0
0.984313725	0.396078431	0
0.980392157	0.407843137	0
0.980392157	0.419607843	0
0.980392157	0.431372549	0
0.980392157	0.443137255	0
0.980392157	0.454901961	0
0.980392157	0.466666667	0
0.980392157	0.478431373	0
0.980392157	0.490196078	0
0.976470588	0.501960784	0
0.976470588	0.51372549	0
0.976470588	0.525490196	0
0.976470588	0.537254902	0
0.976470588	0.549019608	0
0.976470588	0.560784314	0
0.976470588	0.57254902	0
0.976470588	0.584313725	0
0.976470588	0.592156863	0
0.976470588	0.603921569	0
0.976470588	0.615686275	0
0.976470588	0.62745098	0
0.976470588	0.639215686	0
0.976470588	0.650980392	0
0.976470588	0.662745098	0
0.976470588	0.674509804	0
0.976470588	0.682352941	0
0.976470588	0.694117647	0
0.976470588	0.705882353	0
0.976470588	0.717647059	0
0.976470588	0.729411765	0
0.976470588	0.741176471	0
0.976470588	0.752941176	0
0.976470588	0.764705882	0
0.976470588	0.776470588	0
0.976470588	0.784313725	0
0.976470588	0.796078431	0
0.976470588	0.807843137	0
0.976470588	0.819607843	0
0.976470588	0.831372549	0
0.976470588	0.843137255	0
0.976470588	0.854901961	0
0.976470588	0.866666667	0
0.976470588	0.874509804	0
0.976470588	0.88627451	0
0.976470588	0.898039216	0
0.976470588	0.909803922	0
0.976470588	0.921568627	0
0.976470588	0.933333333	0
0.976470588	0.945098039	0
0.976470588	0.956862745	0
0.976470588	0.968627451	0
0.97254902	0.97254902	0
0.952941176	0.97254902	0
0.929411765	0.968627451	0
0.905882353	0.968627451	0
0.882352941	0.968627451	0
0.858823529	0.968627451	0
0.839215686	0.968627451	0
0.815686275	0.968627451	0
0.792156863	0.968627451	0
0.768627451	0.968627451	0
0.745098039	0.968627451	0
0.725490196	0.968627451	0
0.701960784	0.968627451	0
0.678431373	0.968627451	0
0.654901961	0.968627451	0
0.631372549	0.968627451	0
0.611764706	0.968627451	0
0.588235294	0.968627451	0
0.564705882	0.968627451	0
0.541176471	0.968627451	0
0.517647059	0.968627451	0
0.498039216	0.968627451	0
0.474509804	0.968627451	0
0.450980392	0.968627451	0
0.42745098	0.968627451	0
0.407843137	0.968627451	0
0.384313725	0.968627451	0
0.360784314	0.968627451	0
0.337254902	0.968627451	0
0.31372549	0.968627451	0
0.294117647	0.968627451	0
0.270588235	0.968627451	0
0.247058824	0.968627451	0
0.223529412	0.968627451	0
0.2	0.968627451	0
0.180392157	0.968627451	0
0.156862745	0.968627451	0
0.133333333	0.968627451	0
0.109803922	0.968627451	0
0.08627451	0.968627451	0
0.066666667	0.968627451	0
0.043137255	0.968627451	0
0.019607843	0.968627451	0
0	0.968627451	0
0	0.960784314	0.023529412
0	0.949019608	0.043137255
0	0.937254902	0.066666667
0	0.925490196	0.090196078
0	0.91372549	0.11372549
0	0.901960784	0.137254902
0	0.890196078	0.160784314
0	0.882352941	0.180392157
0	0.870588235	0.203921569
0	0.858823529	0.22745098
0	0.847058824	0.250980392
0	0.835294118	0.274509804
0	0.823529412	0.298039216
0	0.815686275	0.317647059
0	0.803921569	0.341176471
0	0.792156863	0.364705882
0	0.780392157	0.388235294
0	0.768627451	0.411764706
0	0.756862745	0.435294118
0	0.749019608	0.454901961
0	0.737254902	0.478431373
0	0.725490196	0.501960784
0	0.71372549	0.525490196
0	0.701960784	0.549019608
0	0.690196078	0.57254902
0	0.682352941	0.592156863
0	0.670588235	0.615686275
0	0.658823529	0.639215686
0	0.647058824	0.662745098
0	0.635294118	0.68627451
0	0.623529412	0.709803922
0	0.615686275	0.729411765
0	0.603921569	0.752941176
0	0.592156863	0.776470588
0	0.580392157	0.8
0	0.568627451	0.823529412
0	0.556862745	0.847058824
0	0.549019608	0.866666667
0	0.537254902	0.890196078
0	0.525490196	0.91372549
0	0.51372549	0.937254902
0	0.501960784	0.960784314
0	0.494117647	0.980392157
0.011764706	0.482352941	0.968627451
0.023529412	0.470588235	0.956862745
0.035294118	0.458823529	0.945098039
0.047058824	0.447058824	0.933333333
0.058823529	0.435294118	0.921568627
0.070588235	0.423529412	0.909803922
0.082352941	0.411764706	0.898039216
0.094117647	0.4	0.88627451
0.105882353	0.388235294	0.874509804
0.117647059	0.376470588	0.862745098
0.129411765	0.364705882	0.850980392
0.141176471	0.352941176	0.839215686
0.152941176	0.341176471	0.82745098
0.164705882	0.329411765	0.815686275
0.176470588	0.317647059	0.803921569
0.188235294	0.305882353	0.792156863
0.2	0.294117647	0.780392157
0.211764706	0.282352941	0.768627451
0.223529412	0.270588235	0.756862745
0.235294118	0.258823529	0.745098039
0.247058824	0.247058824	0.733333333
0.258823529	0.235294118	0.721568627
0.270588235	0.223529412	0.709803922
0.282352941	0.211764706	0.698039216
0.294117647	0.2	0.68627451
0.305882353	0.188235294	0.674509804
0.317647059	0.176470588	0.662745098
0.329411765	0.164705882	0.650980392
0.341176471	0.152941176	0.639215686
0.352941176	0.141176471	0.62745098
0.364705882	0.129411765	0.615686275
0.376470588	0.117647059	0.603921569
0.388235294	0.105882353	0.592156863
0.4	0.094117647	0.580392157
0.411764706	0.082352941	0.568627451
0.423529412	0.070588235	0.556862745
0.435294118	0.058823529	0.545098039
0.447058824	0.047058824	0.533333333
0.462745098	0.035294118	0.525490196
0.474509804	0.023529412	0.51372549
0.48627451	0.011764706	0.501960784
0.494117647	0	0.490196078
0.490196078	0	0.48627451
0.482352941	0	0.478431373
0.478431373	0	0.474509804
0.470588235	0	0.466666667
0.466666667	0	0.462745098
0.458823529	0	0.454901961
0.454901961	0	0.450980392
0.447058824	0	0.443137255
0.443137255	0	0.439215686
0.435294118	0	0.431372549
0.431372549	0	0.42745098
0.423529412	0	0.419607843
0.419607843	0	0.415686275
0.411764706	0	0.407843137
0.407843137	0	0.403921569
0.4	0	0.396078431
0.396078431	0	0.392156863
0.388235294	0	0.388235294
0.384313725	0	0.380392157
0.376470588	0	0.376470588
0.37254902	0	0.368627451
0.364705882	0	0.364705882
0.360784314	0	0.356862745
0.352941176	0	0.352941176
0.349019608	0	0.345098039
0.341176471	0	0.341176471
0.337254902	0	0.333333333
0.329411765	0	0.329411765
0.325490196	0	0.321568627
0.317647059	0	0.317647059
0.31372549	0	0.309803922
0.305882353	0	0.305882353
0.301960784	0	0.298039216
0.294117647	0	0.294117647
0.290196078	0	0.28627451
0.282352941	0	0.282352941
0.278431373	0	0.274509804
0.270588235	0	0.270588235
0.266666667	0	0.262745098
0.258823529	0	0.258823529
0.254901961	0	0.254901961
0.250980392	0	0.250980392
];

x = [1:96];
y = depth;
imagesc(x, y, imfinse);
colormap(newmap);
caxis([-0.02, 0.02]);
colorbar('northoutside');
hold on;